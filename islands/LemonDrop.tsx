import { useEffect, useRef, useState } from "preact/hooks";
import { Spring, WaveTank } from "../components/WaveTank.ts";

function easeInCirc(x: number) {
  return 1 - Math.sqrt(1 - Math.pow(x, 2));
}

const waveTank = new WaveTank();

function LemonDrop() {
  const SVG_WIDTH = 100;
  const [counter, setCounter] = useState(0);
  const [dropy, setDropy] = useState(60);
  const [width, setWidth] = useState(SVG_WIDTH);
  const widthRef = useRef(width);
  const [springs, setSprings] = useState<Spring[]>(waveTank.springs);
  const requestIdRef = useRef<number>();
  const grid = SVG_WIDTH / waveTank.waveLength;
  const points = [
    [0, 100],
    [0, 0],
    ...springs.map((x, i) => [i * grid, x.p]),
    [width, 0],
    [width, 100],
  ];
  const springsPath = `${points.map((x) => x.join(",")).join(" ")}`;
  const juice = `M18 ${63 + counter} C15 ${63 + counter} 16 ${
    63 + counter
  } 12 61L9 56C2 33 62 -3 80 12C103 27 44 56 29 58C27 58 25 59 24 61C20 ${
    63 + counter
  } 21 ${63 + counter} 18 ${63 + counter}Z`;

  function updateJuice(timestamp: number) {
    const amp = 40;
    const x = timestamp / 2000;
    const saw = x - Math.floor(x);
    if (saw < 0.6) {
      setCounter(easeInCirc(saw) * amp);
      setDropy(-100);
    } else {
      setCounter(easeInCirc(1 - saw) * amp * 0.1);
      setDropy(70 + Math.pow(saw - 0.6, 2) * 10000);
    }
  }

  function update(timestamp: number) {
    updateJuice(timestamp);
    waveTank.update(waveTank.springs);
    setSprings([...waveTank.springs]);

    const offset = 500;
    const saw =
      (timestamp + offset) / 2000 - Math.floor((timestamp + offset) / 2000);
    if (saw < 0.01) {
      drop();
    }
    requestIdRef.current = globalThis.requestAnimationFrame(update);
  }

  function resize() {
    setWidth(document.body.clientWidth);
  }

  function drop() {
    const dropPosition = Math.round(
      ((widthRef.current / 2 - 30) / widthRef.current) * 100
    );
    waveTank.springs[dropPosition].p = -60;
  }

  useEffect(() => {
    widthRef.current = width;
  }, [width]);

  useEffect(() => {
    const mediaQuery = window.matchMedia("(prefers-reduced-motion: reduce)");
    if (mediaQuery.matches) {
      return;
    }

    requestIdRef.current = requestAnimationFrame(update);
    globalThis.addEventListener("resize", resize);
    resize();

    return () => {
      globalThis.removeEventListener("resize", resize);
      if (requestIdRef.current !== undefined) {
        cancelAnimationFrame(requestIdRef.current);
      }
    };
  }, []);

  return (
    <>
      <svg
        width="385.854"
        height="63.028"
        viewBox="0 0 385.854 63.028"
        xmlns="http://www.w3.org/2000/svg"
        class="absolute"
      >
        <g
          id="svgGroup"
          stroke-linecap="round"
          fill-rule="evenodd"
          font-size="9pt"
          stroke="#000"
          stroke-width="0.25mm"
          fill="#000"
          style="stroke:#000;stroke-width:0.25mm;fill:#000"
        >
          <path
            d="M 77.144 49.014 L 72.939 49.014 L 72.939 23.379 A 5.94 5.94 0 0 0 72.461 21.004 A 6.13 6.13 0 0 0 71.162 19.072 A 6.13 6.13 0 0 0 69.231 17.774 A 5.94 5.94 0 0 0 66.855 17.295 L 64.771 17.295 A 5.94 5.94 0 0 0 62.395 17.774 A 6.341 6.341 0 0 0 60.447 19.072 Q 59.609 19.893 59.131 21.004 A 5.94 5.94 0 0 0 58.652 23.379 L 58.652 49.014 L 54.482 49.014 L 54.482 23.379 A 5.94 5.94 0 0 0 54.004 21.004 Q 53.525 19.893 52.688 19.072 A 6.341 6.341 0 0 0 50.74 17.774 A 5.94 5.94 0 0 0 48.364 17.295 L 46.279 17.295 A 5.94 5.94 0 0 0 43.904 17.774 A 6.13 6.13 0 0 0 41.973 19.072 A 6.13 6.13 0 0 0 40.674 21.004 A 5.94 5.94 0 0 0 40.195 23.379 L 40.195 49.014 L 35.991 49.014 L 35.991 14.014 L 37.393 14.014 L 39.683 17.569 Q 41.118 15.62 43.289 14.475 A 9.989 9.989 0 0 1 48.022 13.33 L 48.364 13.33 A 10.324 10.324 0 0 1 52.259 14.057 A 9.816 9.816 0 0 1 53.73 14.8 A 10.1 10.1 0 0 1 57.422 18.697 Q 58.071 17.5 59.028 16.509 A 10.401 10.401 0 0 1 61.147 14.817 A 10.482 10.482 0 0 1 63.677 13.723 Q 65.044 13.33 66.514 13.33 L 66.855 13.33 Q 68.975 13.33 70.854 14.134 Q 72.734 14.937 74.136 16.338 Q 75.537 17.739 76.34 19.619 Q 77.144 21.499 77.144 23.618 L 77.144 49.014 Z M 29.702 49.014 L 24.951 49.014 L 14.868 28.643 L 4.785 49.014 L 0 49.014 L 12.476 23.823 L 0.718 0 L 5.469 0 L 14.868 18.97 L 24.233 0 L 28.984 0 L 17.227 23.823 L 29.702 49.014 Z M 86.611 0 L 97.446 38.247 L 97.583 40.059 L 97.72 38.247 L 108.589 0 L 113.135 0 L 98.711 49.014 L 96.387 49.014 L 82.031 0 L 86.611 0 Z M 335.371 14.014 L 317.666 63.028 L 313.599 63.028 L 319.819 46.006 L 308.472 14.014 L 312.676 14.014 L 321.802 40.537 L 321.938 42.349 L 322.075 40.537 L 331.167 14.014 L 335.371 14.014 Z M 178.315 49.697 L 175.513 49.697 Q 173.394 49.697 171.514 48.894 Q 169.634 48.091 168.232 46.69 Q 166.831 45.288 166.028 43.408 Q 165.225 41.529 165.225 39.409 L 165.225 23.618 Q 165.225 21.499 166.028 19.619 Q 166.831 17.739 168.232 16.338 Q 169.634 14.937 171.514 14.134 Q 173.394 13.33 175.513 13.33 L 178.315 13.33 Q 180.435 13.33 182.314 14.134 Q 184.194 14.937 185.596 16.338 Q 186.997 17.739 187.8 19.619 Q 188.604 21.499 188.604 23.618 L 188.604 31.856 L 169.429 31.856 L 169.429 39.649 A 5.94 5.94 0 0 0 169.907 42.024 A 6.13 6.13 0 0 0 171.206 43.955 A 6.13 6.13 0 0 0 173.137 45.254 A 5.94 5.94 0 0 0 175.513 45.733 L 178.315 45.733 A 5.94 5.94 0 0 0 180.691 45.254 A 6.13 6.13 0 0 0 182.622 43.955 A 6.13 6.13 0 0 0 183.921 42.024 A 5.94 5.94 0 0 0 184.399 39.649 L 184.399 37.324 L 188.604 38.008 L 188.604 39.409 Q 188.604 41.529 187.8 43.408 Q 186.997 45.288 185.596 46.69 Q 184.194 48.091 182.314 48.894 Q 180.435 49.697 178.315 49.697 Z M 352.666 49.697 L 349.863 49.697 Q 347.744 49.697 345.864 48.894 Q 343.984 48.091 342.583 46.69 Q 341.182 45.288 340.378 43.408 Q 339.575 41.529 339.575 39.409 L 339.575 23.618 Q 339.575 21.499 340.378 19.619 Q 341.182 17.739 342.583 16.338 Q 343.984 14.937 345.864 14.134 Q 347.744 13.33 349.863 13.33 L 352.666 13.33 Q 354.785 13.33 356.665 14.134 Q 358.545 14.937 359.946 16.338 Q 361.348 17.739 362.151 19.619 Q 362.954 21.499 362.954 23.618 L 362.954 31.856 L 343.779 31.856 L 343.779 39.649 A 5.94 5.94 0 0 0 344.258 42.024 A 6.13 6.13 0 0 0 345.557 43.955 A 6.13 6.13 0 0 0 347.488 45.254 A 5.94 5.94 0 0 0 349.863 45.733 L 352.666 45.733 A 5.94 5.94 0 0 0 355.042 45.254 A 6.13 6.13 0 0 0 356.973 43.955 A 6.13 6.13 0 0 0 358.271 42.024 A 5.94 5.94 0 0 0 358.75 39.649 L 358.75 37.324 L 362.954 38.008 L 362.954 39.409 Q 362.954 41.529 362.151 43.408 Q 361.348 45.288 359.946 46.69 Q 358.545 48.091 356.665 48.894 Q 354.785 49.697 352.666 49.697 Z M 303.584 49.014 L 302.183 49.014 L 299.858 45.528 Q 298.423 47.407 296.27 48.552 A 9.889 9.889 0 0 1 291.553 49.697 L 290.493 49.697 Q 288.374 49.697 286.494 48.894 Q 284.614 48.091 283.213 46.69 Q 281.812 45.288 281.008 43.408 Q 280.205 41.529 280.205 39.409 L 280.205 39.068 Q 280.205 36.948 281.008 35.069 Q 281.812 33.189 283.213 31.787 Q 284.614 30.386 286.494 29.583 Q 288.374 28.78 290.493 28.78 L 299.38 28.78 L 299.38 23.379 A 5.94 5.94 0 0 0 298.901 21.004 A 6.13 6.13 0 0 0 297.603 19.072 A 6.13 6.13 0 0 0 295.671 17.774 A 5.94 5.94 0 0 0 293.296 17.295 L 290.835 17.295 A 5.94 5.94 0 0 0 288.459 17.774 A 6.13 6.13 0 0 0 286.528 19.072 A 6.13 6.13 0 0 0 285.229 21.004 A 5.94 5.94 0 0 0 284.751 23.379 L 284.751 24.644 L 280.547 23.96 L 280.547 23.618 Q 280.547 21.499 281.35 19.619 Q 282.153 17.739 283.555 16.338 Q 284.956 14.937 286.836 14.134 Q 288.716 13.33 290.835 13.33 L 293.296 13.33 Q 295.415 13.33 297.295 14.134 Q 299.175 14.937 300.576 16.338 Q 301.978 17.739 302.781 19.619 Q 303.584 21.499 303.584 23.618 L 303.584 49.014 Z M 156.816 49.014 L 155.415 49.014 L 153.091 45.459 Q 151.655 47.407 149.502 48.552 A 9.889 9.889 0 0 1 144.785 49.697 L 143.726 49.697 Q 141.606 49.697 139.727 48.894 Q 137.847 48.091 136.445 46.69 Q 135.044 45.288 134.241 43.408 Q 133.438 41.529 133.438 39.409 L 133.438 23.618 Q 133.438 21.499 134.241 19.619 Q 135.044 17.739 136.445 16.338 Q 137.847 14.937 139.727 14.134 Q 141.606 13.33 143.726 13.33 L 144.785 13.33 Q 147.144 13.33 149.16 14.287 Q 151.177 15.244 152.612 16.953 L 152.612 0 L 156.816 0 L 156.816 49.014 Z M 245.718 30.181 L 234.609 30.181 L 234.609 49.014 L 230.2 49.014 L 230.2 0 L 245.718 0 Q 248.213 0 250.417 0.94 A 12.077 12.077 0 0 1 254.263 3.521 A 12.077 12.077 0 0 1 256.843 7.366 Q 257.783 9.571 257.783 12.066 L 257.783 18.15 Q 257.783 20.645 256.843 22.832 A 12.129 12.129 0 0 1 254.263 26.66 A 12.077 12.077 0 0 1 250.417 29.241 Q 248.213 30.181 245.718 30.181 Z M 270.396 49.014 L 266.191 49.014 L 266.191 0 L 270.396 0 L 270.396 49.014 Z M 210.103 49.697 L 207.3 49.697 Q 205.181 49.697 203.301 48.894 Q 201.421 48.091 200.02 46.69 Q 198.618 45.288 197.815 43.408 Q 197.012 41.529 197.012 39.409 L 197.012 23.618 Q 197.012 21.499 197.815 19.619 Q 198.618 17.739 200.02 16.338 Q 201.421 14.937 203.301 14.134 Q 205.181 13.33 207.3 13.33 L 210.103 13.33 Q 212.222 13.33 214.102 14.134 Q 215.981 14.937 217.383 16.338 Q 218.784 17.739 219.587 19.619 Q 220.391 21.499 220.391 23.618 L 220.391 39.409 Q 220.391 41.529 219.587 43.408 Q 218.784 45.288 217.383 46.69 Q 215.981 48.091 214.102 48.894 Q 212.222 49.697 210.103 49.697 Z M 385.854 18.013 L 381.65 18.013 A 5.94 5.94 0 0 0 379.275 18.491 A 6.13 6.13 0 0 0 377.344 19.79 A 6.13 6.13 0 0 0 376.045 21.721 A 5.94 5.94 0 0 0 375.566 24.097 L 375.566 49.014 L 371.362 49.014 L 371.362 14.014 L 372.764 14.014 L 375.054 17.569 Q 376.489 15.62 378.66 14.475 A 9.989 9.989 0 0 1 383.394 13.33 L 385.854 13.33 L 385.854 18.013 Z M 123.628 49.014 L 119.424 49.014 L 119.424 14.014 L 123.628 14.014 L 123.628 49.014 Z M 152.612 39.649 L 152.612 23.379 A 5.94 5.94 0 0 0 152.134 21.004 A 6.13 6.13 0 0 0 150.835 19.072 A 6.13 6.13 0 0 0 148.904 17.774 A 5.94 5.94 0 0 0 146.528 17.295 L 143.726 17.295 A 5.94 5.94 0 0 0 141.35 17.774 A 6.13 6.13 0 0 0 139.419 19.072 A 6.13 6.13 0 0 0 138.12 21.004 A 5.94 5.94 0 0 0 137.642 23.379 L 137.642 39.649 A 5.94 5.94 0 0 0 138.12 42.024 A 6.13 6.13 0 0 0 139.419 43.955 A 6.13 6.13 0 0 0 141.35 45.254 A 5.94 5.94 0 0 0 143.726 45.733 L 146.528 45.733 A 5.94 5.94 0 0 0 148.904 45.254 A 6.13 6.13 0 0 0 150.835 43.955 A 6.13 6.13 0 0 0 152.134 42.024 A 5.94 5.94 0 0 0 152.612 39.649 Z M 216.187 39.649 L 216.187 23.379 A 5.94 5.94 0 0 0 215.708 21.004 A 6.13 6.13 0 0 0 214.409 19.072 A 6.13 6.13 0 0 0 212.478 17.774 A 5.94 5.94 0 0 0 210.103 17.295 L 207.3 17.295 A 5.94 5.94 0 0 0 204.924 17.774 A 6.13 6.13 0 0 0 202.993 19.072 A 6.13 6.13 0 0 0 201.694 21.004 A 5.94 5.94 0 0 0 201.216 23.379 L 201.216 39.649 A 5.94 5.94 0 0 0 201.694 42.024 A 6.13 6.13 0 0 0 202.993 43.955 A 6.13 6.13 0 0 0 204.924 45.254 A 5.94 5.94 0 0 0 207.3 45.733 L 210.103 45.733 A 5.94 5.94 0 0 0 212.478 45.254 A 6.13 6.13 0 0 0 214.409 43.955 A 6.13 6.13 0 0 0 215.708 42.024 A 5.94 5.94 0 0 0 216.187 39.649 Z M 253.374 18.15 L 253.374 12.066 A 7.702 7.702 0 0 0 252.936 9.455 A 7.292 7.292 0 0 0 252.759 9.007 Q 252.144 7.588 251.067 6.511 A 7.992 7.992 0 0 0 248.572 4.82 A 7.565 7.565 0 0 0 245.666 4.206 A 8.67 8.67 0 0 0 245.513 4.204 L 234.609 4.204 L 234.609 25.977 L 245.513 25.977 A 7.702 7.702 0 0 0 248.123 25.539 A 7.292 7.292 0 0 0 248.572 25.362 A 8.141 8.141 0 0 0 251.067 23.687 Q 252.144 22.627 252.759 21.209 A 7.565 7.565 0 0 0 253.373 18.303 A 8.67 8.67 0 0 0 253.374 18.15 Z M 299.38 39.649 L 299.38 32.061 L 290.493 32.061 A 5.94 5.94 0 0 0 288.118 32.539 Q 287.007 33.018 286.187 33.855 A 6.341 6.341 0 0 0 284.888 35.803 A 5.94 5.94 0 0 0 284.409 38.179 L 284.409 39.649 A 5.94 5.94 0 0 0 284.888 42.024 A 6.13 6.13 0 0 0 286.187 43.955 A 6.13 6.13 0 0 0 288.118 45.254 A 5.94 5.94 0 0 0 290.493 45.733 L 293.296 45.733 A 5.94 5.94 0 0 0 295.671 45.254 A 6.13 6.13 0 0 0 297.603 43.955 A 6.13 6.13 0 0 0 298.901 42.024 A 5.94 5.94 0 0 0 299.38 39.649 Z M 184.399 28.574 L 184.399 23.379 A 5.94 5.94 0 0 0 183.921 21.004 A 6.13 6.13 0 0 0 182.622 19.072 A 6.13 6.13 0 0 0 180.691 17.774 A 5.94 5.94 0 0 0 178.315 17.295 L 175.513 17.295 A 5.94 5.94 0 0 0 173.137 17.774 A 6.13 6.13 0 0 0 171.206 19.072 A 6.13 6.13 0 0 0 169.907 21.004 A 5.94 5.94 0 0 0 169.429 23.379 L 169.429 28.574 L 184.399 28.574 Z M 358.75 28.574 L 358.75 23.379 A 5.94 5.94 0 0 0 358.271 21.004 A 6.13 6.13 0 0 0 356.973 19.072 A 6.13 6.13 0 0 0 355.042 17.774 A 5.94 5.94 0 0 0 352.666 17.295 L 349.863 17.295 A 5.94 5.94 0 0 0 347.488 17.774 A 6.13 6.13 0 0 0 345.557 19.072 A 6.13 6.13 0 0 0 344.258 21.004 A 5.94 5.94 0 0 0 343.779 23.379 L 343.779 28.574 L 358.75 28.574 Z M 123.97 5.606 L 119.082 5.606 L 119.082 0 L 123.97 0 L 123.97 5.606 Z"
            vector-effect="non-scaling-stroke"
          />
        </g>
      </svg>
      <svg
        width="100"
        height="300"
        viewBox="0 0 100 300"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
        // class="mt-36"
        role="img"
        aria-label="Fresh logo"
      >
        <circle cx="18" cy={dropy} r="4" fill="white"></circle>
        {/* <path
          d="M11.9 96.3v24H7v-24h4.9Zm7.5 10.2v4h-8.8v-4h8.8Zm1-10.2v4h-9.8v-4h9.8ZM23.2 96.3H31c1.6 0 3 .3 4.1.9 1.1.5 2 1.3 2.6 2.4a8 8 0 0 1 1 4c0 1.3-.2 2.4-.6 3.3-.3 1-.8 1.7-1.5 2.3-.7.6-1.4 1-2.3 1.5l-1.5.8h-6.3v-4h4.3a3 3 0 0 0 1.7-.4c.4-.3.7-.7 1-1.2a5 5 0 0 0 .3-2c0-.7-.1-1.3-.3-1.9-.2-.5-.5-1-1-1.2-.3-.3-.9-.5-1.5-.5h-3v20h-4.8v-24Zm11 24-4.4-10.7h5l4.6 10.5v.2h-5.2ZM55.9 116.3v4H45.4v-4h10.5Zm-9-20v24H42v-24H47Zm7.6 9.8v3.8h-9.1v-3.8h9Zm1.4-9.8v4H45.4v-4h10.5ZM69 114c0-.4 0-.8-.2-1.1 0-.4-.2-.7-.5-1l-1-1-1.9-.8-2.6-1.2-2.2-1.5a6.5 6.5 0 0 1-1.7-2 6 6 0 0 1-.5-2.7c0-1 .1-2 .5-2.7a6 6 0 0 1 1.6-2.2c.7-.5 1.5-1 2.4-1.3a9.5 9.5 0 0 1 7.1.5c1.2.6 2 1.5 2.7 2.6.6 1 1 2.4 1 3.8h-5a5 5 0 0 0-.2-1.8c-.2-.5-.5-1-1-1.2-.4-.3-1-.5-1.6-.5-.6 0-1.1.2-1.5.4-.4.2-.7.6-1 1l-.2 1.4c0 .4.1.8.3 1.1l.8.8a21.3 21.3 0 0 0 2.8 1.4l2.9 1.4a9 9 0 0 1 2 1.8c.7.6 1 1.3 1.4 2a7.9 7.9 0 0 1-.1 5.5c-.4.8-.9 1.5-1.5 2.1a7 7 0 0 1-2.5 1.4c-2 .5-1 1.8-3 1.8s-1.3-1.5-3.2-1.8c-1-.3-2-.8-2.7-1.4a6.7 6.7 0 0 1-1.8-2.5c-.4-1-.6-2.2-.6-3.5h4.9c0 .7 0 1.3.2 1.8.1.5.3 1 .6 1.3.3.2.7.5 1.1.6.5.2 1 .2 1.5.2.7 0 1.2 0 1.6-.3.4-.3.6-.6.8-1 .2-.4.3-.9.3-1.4ZM90.5 106v4h-10v-4h10Zm-8.6-9.7v24h-4.8v-24h4.8Zm12.1 0v24h-4.8v-24H94Z"
          fill="#0A140C"
        /> */}
        <path
          d="M84 16c13 27 1 52-7 59 0 4-9 9-12 7-12 5-38-2-53-21-6-7 1-21 21-36 13-10 33-17 51-9Z"
          fill="#FFD80B"
        />
        <path d={juice} fill="white" />
        <path
          d="M69 15c15-1 9 10-6 19L44 44c-2 1-4-2-6 0l-3 6c-3 1-13 3-16 2-5-2-5-9 5-18l7-4c-1-2-1-2 2-5 3-2 19-10 29-11l1 2 6-1Z"
          fill="#FFED4E"
        />
        <path
          d="M38 35c1-1 3-2 3-4l8-3c0 1-1 3 1 4-2 1-7 1-8 5-1-2-1-2-4-2Z"
          fill="#fff"
        />
      </svg>
      <svg
        width="100%"
        height="100px"
        viewBox="0 0 100 100"
        preserveAspectRatio="none"
        class="-mt-5"
      >
        <polygon
          points={springsPath}
          fill="white"
          transform="translate(0, 50)"
        ></polygon>
      </svg>
    </>
  );
}

export default LemonDrop;
